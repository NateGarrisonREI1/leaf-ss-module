-- 040_jobs_and_snapshots.sql
-- jobs = raw intake payload storage
-- snapshots = computed outputs storage (separated from catalog)
-- NOTE: We drop/recreate to avoid conflicts with pre-existing tables.

drop table if exists public.snapshots cascade;
drop table if exists public.jobs cascade;

create table public.jobs (
  id uuid primary key default gen_random_uuid(),

  source text not null default 'web',          -- e.g. web, admin, api
  status public.job_status not null default 'new',

  raw_payload jsonb not null default '{}'::jsonb,

  error_message text,

  created_at timestamptz not null default now(),
  updated_at timestamptz not null default now()
);

create index jobs_status_idx
  on public.jobs (status);

create index jobs_source_idx
  on public.jobs (source);

create index jobs_raw_payload_gin
  on public.jobs using gin (raw_payload);

drop trigger if exists trg_jobs_set_updated_at on public.jobs;

create trigger trg_jobs_set_updated_at
before update on public.jobs
for each row
execute function public.set_updated_at();


create table public.snapshots (
  id uuid primary key default gen_random_uuid(),

  job_id uuid not null references public.jobs(id) on delete cascade,

  snapshot_version text not null default 'v1',

  computed_results jsonb not null default '{}'::jsonb,

  created_at timestamptz not null default now()
);

create index snapshots_job_id_idx
  on public.snapshots (job_id);

create index snapshots_version_idx
  on public.snapscc
